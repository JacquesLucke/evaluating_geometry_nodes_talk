<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>Evaluating Geometry Nodes</title>

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/black.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
      integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <style>
      #response > div {
        background-color: aqua;
        text-align: left;
        padding-left: 1em;
        color: black;
      }

      #qrcode {
        padding: 20px;
        background-color: #ccc;
        width: fit-content;
        height: fit-content;
      }

      #qrcode > img {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>Evaluating Geometry Nodes</section>
        <section>
          Who are you?
          <br />
          <button id="settings">Settings</button>
          <button id="who-are-you-poll">Start Poll</button>
          <div id="qrcode"></div>
          <div id="response"></div>
        </section>
      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      Reveal.initialize({
        hash: true,
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });
    </script>

    <script>
      let server_url = "http://192.168.0.15:8080";
      let session_id = localStorage.getItem("session_id") || "1234";

      function change_id(e) {
        session_id = document.getElementById("id-input").value;
        localStorage.setItem("session_id", session_id);
      }

      function update_poll_page(page_str) {
        fetch(`${server_url}/${session_id}/set_page`, {
          method: "POST",
          body: page_str,
        });
      }

      document.getElementById("settings").addEventListener("click", () => {
        Swal.fire({
          html: `<input onchange='change_id()' id='id-input' value='${session_id}'></input>`,
        });
      });

      document
        .getElementById("who-are-you-poll")
        .addEventListener("click", async () => {
          let template = await fetch("multiple_choice.template.html");
          template = await template.text();
          update_poll_page(template);
        });

      setInterval(async () => {
        let responses = await fetch(`${server_url}/${session_id}/responses`);
        responses = await responses.json();
        // Reverse so that latest response for each user is used.
        responses.reverse();

        const response_counts = new Map();
        const handled_users = new Set();
        let total_responses = 0;
        for (let response of responses) {
          response = JSON.parse(response);
          const user_id = response.user_id;
          if (handled_users.has(user_id)) {
            continue;
          }
          const data = response.data;
          handled_users.add(user_id);
          response_counts.set(data, (response_counts.get(data) || 0) + 1);
          total_responses++;
        }

        const response_container = document.getElementById("response");
        response_container.innerHTML = "";
        for (const [response, count] of response_counts.entries()) {
          const bar_elem = document.createElement("div");
          bar_elem.innerText = `${response}: ${count}`;
          const percentage = (count / total_responses) * 100;
          bar_elem.style.width = `${percentage}%`;
          response_container.appendChild(bar_elem);
        }
      }, 100);

      const qrcode = new QRCode(document.getElementById("qrcode"), {
        text: `${server_url}/${session_id}`,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctionLevel: QRCode.CorrectLevel.L,
      });
    </script>
  </body>
</html>
